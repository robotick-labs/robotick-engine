name: CI - Build & Test (esp32s3)

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  esp32s3-build:
    runs-on: ubuntu-latest
    name: Build & Test (esp32s3)

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ğŸ’¾ Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.docker-cache-esp32s3
          key: docker-esp32s3-${{ hashFiles('docker/Docker.esp32s3.dev') }}
          restore-keys: |
            docker-esp32s3-

      - name: ğŸ“¦ Load Docker cache
        run: |
          mkdir -p /tmp/.docker-cache-esp32s3
          if [ -f /tmp/.docker-cache-esp32s3/image.tar ]; then
            docker load -i /tmp/.docker-cache-esp32s3/image.tar || true
          fi

      - name: ğŸ§¹ Free disk space (dotnet/android/ghc)
        run: |
          # This job does not use .NET, Android SDK, or GHC.
          # These are wiped deliberately to reclaim ~15 GB disk space on GitHub-hosted runners
          # in order to give space for Docker image building and other items.
          sudo rm -rf /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc || true
          df -h

      - name: ğŸ§¹ Prune Docker system
        run: |
          # Intentionally prune everything to free ~15 GB; no other jobs in this workflow
          docker system prune -af || true
          df -h

      - name: ğŸ—ï¸ Build Docker image (robotick-dev:esp32s3)
        run: |
          docker build \
            --cache-from robotick-dev:esp32s3 \
            -t robotick-dev:esp32s3 \
            -f docker/Docker.esp32s3.dev \
            .

      - name: ğŸ’¾ Save Docker image to cache
        run: |
          mkdir -p /tmp/.docker-cache-esp32s3
          docker save robotick-dev:esp32s3 > /tmp/.docker-cache-esp32s3/image.tar

      - name: ğŸ”§ Run IDF Clean + Build inside Docker
        run: |
          docker run --rm -t \
            --user root \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace/examples/cpp/esp32-testbed \
            -e TERM=xterm-256color \
            robotick-dev:esp32s3 \
            bash -c "
              set -e
              echo 'ğŸ§¹ Running IDF clean...'
              ./1_idf_clean.sh
              echo 'ğŸ› ï¸  Running IDF build...'
              ./2_idf_build.sh
            "
