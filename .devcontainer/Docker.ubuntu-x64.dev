FROM ubuntu:24.04

# üõ† Install system dependencies + Paho MQTT C from apt
RUN apt-get update && apt-get install -y \
    cmake \
    clang \
    clang-tidy \
    curl \
    g++ \
    make \
    git \
    python3 \
    python3-pip \
    python3-venv \
    ninja-build \
    gdb \
    libssl-dev \
    libpaho-mqtt-dev \
    libpaho-mqtt1.3 && \
    apt-get clean

# üîß Build and install Paho MQTT C++ manually
RUN git clone --depth=1 https://github.com/eclipse/paho.mqtt.cpp.git /tmp/paho.mqtt.cpp && \
    cd /tmp/paho.mqtt.cpp && \
    cmake -Bbuild -S. \
        -DPAHO_BUILD_STATIC=TRUE \
        -DPAHO_BUILD_SHARED=TRUE \
        -DCMAKE_PREFIX_PATH=/usr && \
    cmake --build build --target install && \
    ldconfig && \
    rm -rf /tmp/paho.mqtt.cpp

# üêç Python venv and Robotick install
WORKDIR /workspace
COPY . .

RUN python3 -m venv /venv && \
    /venv/bin/pip install -U pip && \
    /venv/bin/pip install -e .

ENV PATH="/venv/bin:$PATH"
