FROM ubuntu:24.04

# 🛠 Install system dependencies for both native and ESP32 builds
RUN apt-get update && apt-get install -y \
    cmake \
    clang \
    clang-tidy \
    curl \
    g++ \
    make \
    git \
    python3 \
    python3-pip \
    python3-venv \
    ninja-build \
    gdb \
    wget \
    flex \
    bison \
    libffi-dev \
    libssl-dev \
    dfu-util \
    libusb-1.0-0 \
    && apt-get clean

# Set working directory
WORKDIR /workspace

# 🧠 Copy source into the container
COPY . .

# 🐍 Create and activate Python venv, install robotick in editable mode
RUN python3 -m venv /venv && \
    /venv/bin/pip install -U pip && \
    /venv/bin/pip install -e .

# 🧰 Install ESP-IDF
ENV IDF_VERSION=v5.1
RUN git clone --branch ${IDF_VERSION} --depth 1 https://github.com/espressif/esp-idf.git /esp-idf && \
    /esp-idf/install.sh

# 🛠 Set up ESP-IDF environment (used by IDF tools + builds)
ENV IDF_PATH=/esp-idf
ENV PATH="/venv/bin:$IDF_PATH/tools:$PATH"

# Activate IDF env by default in bash
RUN echo ". $IDF_PATH/export.sh" >> /etc/bash.bashrc
