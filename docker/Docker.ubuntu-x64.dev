FROM ubuntu:24.04

# üõ† Install system dependencies
RUN apt-get update && apt-get install -y \
    cmake \
    clang \
    clang-tidy \
    clang-format \
    curl \
    g++ \
    make \
    git \
    python3 \
    python3-pip \
    python3-venv \
    ninja-build \
    gdb \
    libssl-dev \
    libcurl4-openssl-dev \
    && apt-get clean

# üîß Build and install Paho MQTT C lib (with exported CMake targets)
RUN git clone --depth=1 https://github.com/eclipse/paho.mqtt.c.git /tmp/paho.mqtt.c && \
    cd /tmp/paho.mqtt.c && \
    cmake -Bbuild -S. \
        -DPAHO_BUILD_STATIC=TRUE \
        -DPAHO_BUILD_SHARED=TRUE \
        -DPAHO_WITH_SSL=TRUE \
        -DPAHO_BUILD_CMAKE_EXPORTS=ON \
        -DCMAKE_INSTALL_PREFIX=/usr && \
    cmake --build build --target install -- -j$(nproc) && \
    ldconfig && \
    rm -rf /tmp/paho.mqtt.c

# üîß Build and install Paho MQTT C++ lib
RUN git clone --depth=1 https://github.com/eclipse/paho.mqtt.cpp.git /tmp/paho.mqtt.cpp && \
    cd /tmp/paho.mqtt.cpp && \
    cmake -Bbuild -S. \
        -DPAHO_BUILD_STATIC=TRUE \
        -DPAHO_BUILD_SHARED=TRUE \
        -DCMAKE_PREFIX_PATH=/usr && \
    cmake --build build --target install -- -j$(nproc) && \
    ldconfig && \
    rm -rf /tmp/paho.mqtt.cpp

# üêç Set up Python venv and install Robotick in editable mode
ARG WORKDIR=/workspace

# Copy everything into container (safe for single-repo or parent-repo setups)
COPY . ${WORKDIR}
WORKDIR ${WORKDIR}

RUN python3 -m venv /venv && \
    /venv/bin/pip install --upgrade pip && \
    if [ -f setup.py ]; then \
        echo "‚úÖ Installing Python package from root"; \
        /venv/bin/pip install -e .; \
    elif [ -f robotick-engine/setup.py ]; then \
        echo "‚úÖ Installing Python package from robotick-engine subdir"; \
        cd robotick-engine && /venv/bin/pip install -e .; \
    else \
        echo "‚ùå setup.py not found!" && exit 1; \
    fi

# üë£ Use venv as default Python environment
ENV PATH="/venv/bin:$PATH"

# Make git happy inside container
RUN git config --global --add safe.directory ${WORKDIR}


